C$PROG SETTER
      SUBROUTINE SETTER(KWDFLG)
C
      COMMON/MAINV8/ A(50,50),B(50,50),DET,IFS
      REAL*8         A,       B,       DET
C
      COMMON/AAX/ SPECT(256,19),ISPK(16384),IBAK(16384),ICAL(16384)
      COMMON/BBB/ XAG(250,7),NPK
      COMMON/CCC/ BGD(256),WT(256),YCAL(256),GAU(200),NG(16)
      COMMON/DDD/ IHOL(16),XP(16),AREA(16),BETA(18),LOCA(250),BIAS
      COMMON/EEE/ ID,ILO,IHI,KWD,FWHMA,FWHMB,EOOO,GAINN,WDNC,DELCH,BSTD
      COMMON/FFF/ HWID(16),QFN,QFLO,IFBGD,NTRY,MSN,NCH,KPK,I1,I2
      COMMON/GGG/ MXNPK,MXRGL,MXPIS,NBNF
      COMMON/HHH/ IGAUS,KNBAK,KNVAR,KVW
      COMMON/IIX/ WSAV(16)
      COMMON/LLL/ MSSG(28),NAMPROG(2),LOGUT,LOGUP,LISFLG,MSGF
C
      DIMENSION JP(16),IUSE(16),PLIM(32),GUESS(16),PARV(16)
C
      CHARACTER*4  KVW
C
      DATA KUSE/0/
C
      SAVE
C
      IF(NPK.LT.1) RETURN
      LOC=0
      LSTJ=1
      KRLST=0
      KWN=KWD
      IF(FWHMA.NE.0.0.OR.FWHMB.NE.0.0) GO TO 60
C
C     ESTIMATE WIDTH FUNCTION FROM SUMMER RESULTS
C
      NPU=0
C
      CALL SELPKS(NPK,XAG(1,3),LOCA)
C
      SW=0.0
      SWX=0.0
      SWXX=0.0
      SWXY=0.0
      SWY=0.0
C
      DO 20 I=1,NPK
      X=XAG(I,7)+1.5
      K=X
      X=SQRT(X)
      PKHT=XAG(I,3)
      IF(PKHT.LT.2000.0) GO TO 20
      Y=0.9392520*XAG(I,1)/PKHT
      DENO=XAG(I,2)
      IF(DENO.LT.1.0) DENO=1.0
      W=10.0/DENO
      W=W*W
      SW=SW+W
      SWX=SWX+W*X
      SWY=SWY+W*Y
      SWXX=SWXX+W*X*X
      SWXY=SWXY+W*X*Y
      NPU=NPU+1
   20 CONTINUE
C
      IF(NPU.GE.2) GO TO 40
      FWHMA=KWD/2
      FWHMB=0.0
      GO TO 60
C
   40 A(1,1)=SW
      A(1,2)=SWX
      A(2,1)=A(1,2)
      A(2,2)=SWXX
      B(1,1)=SWY
      B(2,1)=SWXY
      CALL DMAINV8(2,1)
      FWHMA=B(1,1)
      FWHMB=B(2,1)
      IF(KWDFLG.EQ.0) GO TO 60
C
      CHMED=(IHI-ILO)/2
      KWD=2*(FWHMA+FWHMB*SQRT(CHMED))
      IF(2*(KWD/2).LT.KWD) KWD=KWD+1
      IF(KWD.LT.2) KWD=2
C
   60 LOC=LOC+1
      DO 80 I=1,MXPIS
      IHOL(I)=0
   80 CONTINUE
C
      IF(LOC.GT.NPK) GO TO 540
C
      KPK=1
      RAG=XAG(LOC,7)
      XP(1)=RAG
      IF(FWHMB.NE.0.0) KWN=2*(FWHMA+FWHMB*SQRT(XP(1)))
      IF(2*(KWN/2).LT.KWN) KWN=KWN+1
      IF(KWN.LT.2) KWN=2
      JP(1)=LOC
  100 IF((LOCA(LOC+1)-LOCA(LOC)).GT.2*KWD) GO TO 120
C
      KPK=KPK+1
      JP(KPK)=LOC+1
      RAG=XAG(LOC+1,7)
      XP(KPK)=RAG
      LOC=LOC+1
      XNEXT=XAG(LOC+2,7)
      NEXTR=XNEXT-XP(1)+3*KWN+1
      IF(KPK.GE.MXPIS.OR.NEXTR.GT.MXRGL) GO TO 120
      IF(LOC.GE.NPK) GO TO 120
      GO TO 100
C
  120 DO 140 I=1,KPK
      IF(XP(I).GT.0.0) GO TO 140
      XP(I)=-XP(I)
      IHOL(I)=1
  140 CONTINUE
C
      DO 160 I=1,MXPIS
      IUSE(I)=0
  160 CONTINUE
C
      DO 200 I=1,KPK
      LARGE=0
      DO 180 J=1,KPK
      IF(IUSE(J).GT.0) GO TO 180
      NDX=XP(J)+0.5
      IF(ISPK(NDX).LT.LARGE) GO TO 180
      KUSE=J
      LARGE=ISPK(NDX)
  180 CONTINUE
C
      IUSE(KUSE)=1
      NG(I)=KUSE
  200 CONTINUE
C
      J1=XP(1)-2*KWN
      J2=XP(KPK)+2*KWN
      IF(J2.GT.NCH) J2=NCH
      IF(JP(1).EQ.1) GO TO 220
C
      INDX=JP(1)-1
      JLOM=LOCA(INDX)+KWN
      IF(J1.LT.JLOM) J1=JLOM
  220 IF(JP(KPK).EQ.NPK) GO TO 240
C
      INDX=JP(KPK)+1
      JHIM=LOCA(INDX)-KWN
      IF(J2.GT.JHIM) J2=JHIM
  240 N=0
      IFBGD=0
      JNB=KPK+2
      IF(J1.GT.J2) GO TO 280
      DO 260 I=J1,J2
      N=N+1
      SPECT(N,1)=ISPK(I)
      DENO=ABS(SPECT(N,1))
      IF(DENO.LT.1.0) DENO=1.0
      WT(N)=1.0/DENO
      SPECT(N,JNB)=1.0
      SPECT(N,JNB+1)=N
      IF(N.GE.MXRGL) GO TO 280
  260 CONTINUE
C
  280 I1=1
      I2=N
      SHIFT=J1-1
      DO 300 I=1,KPK
      HWID(I)=(FWHMA+FWHMB*SQRT(XP(I)))/1.66478
      WSAV(I)=HWID(I)
      XP(I)=XP(I)-SHIFT+1
  300 CONTINUE
C
      IF(DELCH.EQ.0.0) GO TO 320
      CALL ONEBY1
  320 IF(WDNC.EQ.0.0)   GO TO 400
      IF(KVW.EQ.'NONE') GO TO 400
      IF(KVW.EQ.'FREE') GO TO 330
C
      CALL  DIDDLW(WDNC)
      GO TO 420
C
  330 NMUL=1
      DEL=WDNC
      DELFAC=0.25
C
      DO 340 I=1,32
      PLIM(I)=3.0
  340 CONTINUE
      DO 350 I=1,KPK
      PLIM(I)=0.3
      GUESS(I)=1.0
  350 CONTINUE
C
      CALL SMIN(KPK,NMUL,DEL,DELFAC,PLIM,GUESS,PARV,FOFX)
      QFN=FOX(PARV)
C
      GO TO 420
C
  400 CALL PKFIT
  420 CONTINUE
C
      DO 440 K=1,KPK
      LOC=JP(K)
      XAG(LOC,3)=1.7724539*HWID(K)*BETA(K)
      DENO=BETA(K)
      IF(DENO.EQ.0.0) DENO=1.0E-10
      XAG(LOC,4)=100.0*SQRT(ABS(QFN*A(K,K)))/DENO
      XAG(LOC,5)=1.66478*HWID(K)
      XAG(LOC,6)=(XP(K)+SHIFT-1)
  440 CONTINUE
C
C     ZERO ALL THE STUF BETWEEN THE LAST REGION AND THIS REGION
C
      NXTJ=J1-1
      IF(LSTJ.GT.NXTJ) GO TO 480
      DO 460 I=LSTJ,NXTJ
      ICAL(I)=0
  460 CONTINUE
C
C     SAVE THE CALCULATED SPECTRUM
C
  480 N=0
      IF(J1.GT.J2) GO TO 520
      DO 500 I=J1,J2
      N=N+1
      ICAL(I)=YCAL(N)+0.5
      IBAK(I)=BGD(N)+0.5
  500 CONTINUE
  520 LSTJ=J2+1
      GO TO 60
C
C     ZERO THE REST OF THE CALCULATED SPECTRUM
C
  540 IF(LSTJ.GT.NCH) GO TO 580
      DO 560 I=LSTJ,NCH
      ICAL(I)=0
  560 CONTINUE
C
  580 RETURN
      END
