C$PROG NUFREQ
      SUBROUTINE NUFREQ
      IMPLICIT REAL*8(A-H,O-Z)
      character*4 ABSORB
c     INTEGER ABSORB
      COMMON/AAA/ A(4), NZ(30), CONST(50), ZZ(25)
      DIMENSION QA(2), QB(2), RDIS(2), RD(2), ELVA(2), ELVB(2),
     1    JRAK(6), AM(4), BM(4), TBACK(2)
      DIMENSION FXFUK(2)
      EQUIVALENCE (CONST(19),DEGRAD), (CONST(26),SE), (CONST(34),XA),
     1(NZ(9),JRAK(1)),(NZ(5),ABSORB)
C   
      EQUIVALENCE (SOLN2 ,ZZ(1)),
     &            (ILRD  ,ZZ(2)),
     &            (IFLAG ,ZZ(3)),
     &            (TARGT ,ZZ(5)),
     &            (KAT   ,ZZ(6)),
     &            (ZT    ,ZZ(7)),
     &            (TBACKT,ZZ(9)),
     &            (ATB   ,ZZ(10)),
     &            (ZTB   ,ZZ(11)),
     &            (NORDER,ZZ(12)),
     &            (TWO   ,ZZ(13))
C   
      DIMENSION IATM(4)
C
      CHARACTER*320 CLWD
C
      INTEGER*4     IWD(20),LWD(2,40),ITYP(40)
C
      EQUIVALENCE  (CLWD,LWD)
C
      DATA TRUE,FALSE/1.0,0.0/
C     ******************************************************************
C   
C     SUBROUTINE NUFREQ USES A GIVEN Q-VALUE BROUGHT TO FOCUS AT A
C     DISTANCE D ALONG THE FOCAL PLANE TO BRING A NEW Q-VALUE TO FOCUS
C     DETECTOR.
C     NUFREQ ALSO FINDS THE Q-VALUE CORRESPONDING TO MAX END OF THE
C     Q-VALUE THIS MUST BE DONE BY AN INTERATIVE PROCESS.
C     AT THE SAME DISTANCE D.  BECAUSE OF KINEMATIC SHIFT CHANGES WITH
C     ******************************************************************
C   
C   
      IMIN=1
      IMAX=80
   50 FORMAT(20A4)
    2 READ(5,55)JRAK
   55 FORMAT(6A4)
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,12)DTHAD,ZOA,EINA,FLAG,IENGY,FXFUK
      ISOLN2=FXFUK(1)+0.5
      IMASS=FXFUK(2)+0.5
      IF (DTHAD.EQ.0.0) RETURN
      IF(IMASS.EQ.0)GO TO 51
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,16)A
   51 READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,10)TARGT,TBACK,TBACKT,ZTB,FXFUK(1),ABSORB
      NORDER=FXFUK(1)+0.5
      READ(5,13)QA
      READ(5,13)THAD
      READ(5,13)F,BA,RD1,RD2
      EIA=EINA
      RDIS(1)=0.0
      RDIS(2)=0.0
      NR=0.0
      IF (ISOLN2.EQ.2) SOLN2= TRUE
      IFLAG=FLAG
      TARGB=2*TBACKT
      IF(IMASS.NE.0) GO TO 3
      CALL PARTFI(JRAK,24,A,IATM,NZ,QGS,IFAIL,ISOR)
      IF (IFAIL.EQ.0) GO TO 3
      WRITE(7,17)JRAK
      RETURN
3     IF (BA.EQ.0.0) BA=F/4.2578
      DO 4 I=1,4
    4 AM(I)=A(I)
      CALL ENERGY (QA,ELVA,IENGY,QGS,2)
      DTH=DTHAD*DEGRAD/2.
      TA=AM(3)*XA
      TMXA=SE/ZOA
      TH=THAD*DEGRAD
      ZT = NZ(2)
      ZZ(7) = ZT
      ZZ(11) = ZTB
      ZPOUT = NZ(3)
      ZPIN = NZ(1)
      IF (TARGT.EQ.0.0) GO TO 5
      IF (NORDER.EQ.1.AND.TBACKT.NE.0.0) CALL ELOSS (EINA,ZPIN,AM(1),
     XZTB,TARGB,'SOLI')
c    XZTB,TARGB,4HSOLI)
      CALL ELOSS(EINA,ZPIN,AM(1),ZT,TARGT,ABSORB)
5     ETARG = EINA
      WRITE(7,24)JRAK,QGS,EIA,ETARG,A(1),TARGT,A(2),TBACK(1),TBACK(2),
     1A(3),TBACKT,A(4),NORDER,ZOA
      CALL CROW (AM,EINA,TH,DTH,ZOA,BA,TA,TMXA,   RDIS,TL,TR,QA,NR,IF)
      WRITE(7,27)BA,F
      WRITE(7,22)THAD,DTHAD
      WRITE(7,23)RD1,RD2
      WRITE(7,20)
      WRITE(7,21)ELVA(1),QA(1),RDIS(1),ELVA(2),QA(2),RDIS(2)
      WRITE(7,26)TL,TR
      READ(5,12)JRAK,DTHBD,ZOB,EINB,TOL,IENGY,FXFUK
      ISOLN2=FXFUK(1)+0.5
      IMASS=FXFUK(2)+0.5
      IF(IMASS.NE.0) READ(5,16)A
C   
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,1,80,NTER)
      READ(CLWD,10)TARGT,TBACK,TBACKT,ZTB,FXFUK(1),ABSORB
      NORDER=FXFUK(1)
      READ(5,13)QB
      READ(5,13)THBD
      TOL=.001
      NRB=0.0
      EIB=EINB
      TARGB=2*TBACKT
      IF (ISOLN2.EQ.2) SOLN2= TRUE
      IF(IMASS.NE.0) GO TO  7
      CALL PARTFI(JRAK,24,A,IATM,NZ,QGS,IFAIL,ISOR)
      IF (IFAIL.EQ.0) GO TO 7
      WRITE(7,17)JRAK
      GO TO 2
    7 DO 8 I=1,4
    8 BM(I)=A(I)
      CALL ENERGY (QB,ELVB,IENGY,QGS,2)
      IF (NRB.EQ.0) NRB=NR
      IF (THBD.EQ.0.0) THBD=THAD
      THB=THBD*DEGRAD
      IF (DTHBD.EQ.0.0) DTHBD=DTHAD
      DTHB=DTHBD*DEGRAD/2.0
      IF (TARGT.EQ.0.0) GO TO 9
      IF (NORDER.EQ.1.AND.TBACKT.NE.0.0) CALL ELOSS (EINB,ZPIN,BM(1),
     XZTB,TARGB,'SOLI')
c    XZTB,TARGB,4HSOLI)
      CALL ELOSS(EINB,ZPIN,BM(1),ZT,TARGT,ABSORB)
9     ETARG=EINB
      WRITE(7,25)JRAK,QGS,EIB,ETARG,A(1),TARGT,A(2),TBACK(1),TBACK(2),
     1A(3),TBACKT,A(4),NORDER,ZOB
      IT=1
      TB=BM(3)*XA
      TMXB=SE/ZOB
      CALL CROW (BM,EINB,THB,DTHB,ZOB,BA,TB,TMXB,   RD,TLB,TRB,QB,NRB,IF
     1)
      WRITE(7,22)THBD,DTHBD
      WRITE(7,19)
      WRITE(7,20)
      WRITE(7,21)ELVB(1),QB(1),RD(1),ELVB(2),QB(2),RD(2)
      WRITE(7,27)TLB,TRB
      RDA=RDIS(1)
      B=BA
      CALL TUNE (BM,EINB,THB,DTHB,ZOB,B,TB,TMXB,   RD,RDA,TOL,TLB,TRB,QB
     1,NRB,IF)
      FN=4.2578*B
      WRITE(7,18)
      WRITE(7,27)B,FN
      WRITE(7,20)
      WRITE(7,21)ELVB(1),QB(1),RD(1),ELVB(2),QB(2),RD(2)
      WRITE(7,26)TLB,TRB
      CALL QEND (BM,EINB,THB,DTHB,ZOB,B,TB,TMXB,   RD,RDA,TLB,TRB,QB,NRB
     1,IF,RD2)
      WRITE(7,11)QB(2),RD2
      GO TO 2
C   
C   
   10 FORMAT(E8.0,2A4,3E8.0,A4)
11    FORMAT (/,35X,3HQ =,F10.5,5H  MEV,12H FOR RDIST =,F10.5,3H CM//)
   12 FORMAT(4E8.0,A4,4X,2E8.0)
   13 FORMAT(10E8.0)
16    FORMAT (8F10.6)
17    FORMAT (14H1FINDER FAILED,10X,6A4)
18    FORMAT (/23X,82H****RE-TUNE MAGNET SUCH THAT RDIST FOR THE FIRST Q
     1-VALUE IS THE SAME AS BEFORE****,/)
19    FORMAT(23X,82H ****CALCULATE RDIST AND DIAL READINGS FOR NEW Q-VAL
     1UES USING OLD MAGNET FIELD****,/)
20    FORMAT (45X,6X,6HELEVEL,5X,7HQ-VALUE,7X,5HRDIST,/)
21    FORMAT (45X,3(2X,F10.5))
22    FORMAT (//,42X,21H REACTION LAB ANGLE =,F10.5,5H  DEG,/,53X,10HAPE
     1RTURE =,F10.5,5H  DEG,//)
23    FORMAT (40X,9HEND MIN =,F8.3,5H  CM ,3X,9HEND MAX =,F8.3,4H  CM/)
24    FORMAT (1H1,50X,31HOUTPUT FOR SUBROUTINE NUFREQ   ,///,1H ,58X,8HR
     1EACTION,/,1H ,53X,6A4,/,51X,6H QGS =,F10.5,5H  MEV,///,41H KINEMAT
     2IC VARIABLES * * * * EBOMB(LAB) =,F10.5,5H  MEV,10X,34HENERGY LOSS
     3 INFO * * * * ETARGET =,F10.5,5H  MEV/,37X,5H M1 =,F10.5,5H  AMU,2
     46X,18HTARGET THICKNESS =,F10.5,8HMG/SQ-CM,/,37X,5H M2 =,F10.5,5H
     5AMU,28X,16HTARGET BACKING =,2A4,/,37X,5H M3 =,F10.5,5H  AMU,24X,20
     6H BACKING THICKNESS =,F10.5,8HMG/SQ-CM,/,37X,5H M4 =,F10.5,5H  AMU
     7,29X,15HBACKING ORDER =,I4,/,36X,6HZOUT =,F5.0,/)
25    FORMAT (1H1,41X,39H*****NOW READ IN A NEW REACTION *****  ,///,58X
     1,8HREACTION,/,1H ,53X,6A4,/,51X,6H QGS =,F10.5,5H  MEV,///,41H KIN
     2EMATIC VARIABLES * * * * EBOMB(LAB) =,F10.5,5H  MEV,10X,34HENERGY
     3LOSS INFO * * * * ETARGET =,F10.5,5H  MEV/,37X,5H M1 =,F10.5,5H  A
     4MU,26X,18HTARGET THICKNESS =,F10.5,8HMG/SQ CM,/,37X,5H M2 =,F10.5,
     55H  AMU,28X,16HTARGET BACKING =,2A4,/,37X,5H M3 =,F10.5,5H  AMU,24
     6X,20H BACKING THICKNESS =,F10.5,8HMG/SQ-CM,/,37X,5H M4 =,F10.5,5H
     7 AMU,29X,15HBACKING ORDER =,I4,/,36X,6HZOUT =,F5.0,/)
26    FORMAT (//,42X,21H  LEFT DIAL READING =,F10.5,/,42X,21H RIGHT DIAL
     1 READING =,F10.5)
27    FORMAT (/,48X,15H MAGNET FIELD =,F10.5,11H  KILOGAUSS,/,51X,12H FR
     1EQUENCY =,F10.5,11H  MEGAHERTZ,//)
      END
