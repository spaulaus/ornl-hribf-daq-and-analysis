C$PROG RHO
      SUBROUTINE RHO
      IMPLICIT REAL*8(A-H,O-Z)
      character*4 ABSORB
c     INTEGER ABSORB
      COMMON/AAA/ V(4), NZ(30), CONST(50), ZZ(25)
      DIMENSION Q(10), THETA(10), CMTOLB(10), E3(10), THCM3(10),
     1 DEXIT(10), XI2PP(10), A(10), DTFP(10), DK(10),
     2 ANOK(10), RDIST(10), IJ(10), EL(10),JRAK(6),
     3 TBACK(2)
      DIMENSION FXFUK(2)
      EQUIVALENCE (CONST(19),DEGRAD),(CONST(26),SE),(CONST(34),XA),
     1(NZ(9),JRAK(1))
C   
      EQUIVALENCE (SOLN2 ,ZZ(1)),
     &            (IFLAG ,ZZ(3)),
     &            (TWO   ,ZZ(13))
C   
      DIMENSION IATM(4)
C
      CHARACTER*320 CLWD
C
      INTEGER*4     IWD(20),LWD(2,40),ITYP(40)
C
      EQUIVALENCE  (CLWD,LWD)
C
      DATA TRUE,FALSE/1.0,0.0/
C   
C   
      IMIN=1
      IMAX=80
    1 READ(5,55)JRAK
   55 FORMAT(6A4)
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,14)DTHETA,ZOUT,EIN,FLAG,IENGY,FXFUK
      ISOLN2=FXFUK(1)+0.5
      IMASS=FXFUK(2)+0.5
      IF (DTHETA.EQ.0.0) GO TO 11
      IF(IMASS.EQ.0)GO TO 51
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,13)V
   51 READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,12)TARGT,TBACK,TBACKT,ZTB,FXFUK(1),ABSORB
      NORDER=FXFUK(1)+0.5
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,20)Q
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,20)ANGI,ANGFI,DEL
   50 FORMAT(20A4)
      READ(5,50)IWD
      CALL GREAD(IWD,LWD,ITYP,NF,IMIN,IMAX,NTER)
      READ(CLWD,20)DELRHO,RHOMIN
      IF (ISOLN2.EQ.2) SOLN2= TRUE
      EI=EIN
      DTHET = DTHETA
      TARGB=2*TBACKT
      IFLAG=FLAG
      IF(IMASS.NE.0) GO TO 2
      CALL PARTFI(JRAK,24,V,IATM,NZ,QGS,IFAIL,ISOR)
      IF (IFAIL.EQ.0) GO TO 2
      WRITE(7,21)JRAK
      GO TO 1
2     XM1A=V(1)
      XM2A=V(2)
      XM3A=V(3)
      XM4A=V(4)
      ZT = NZ(2)
      ZZ(7) = ZT
      ZZ(11) = ZTB
      ZPOUT = NZ(3)
      ZPIN = NZ(1)
      IF (TARGT.EQ.0.0) GO TO 3
      IF (NORDER.EQ.1.AND.TBACKT.NE.0.0) CALL ELOSS (EIN,ZPIN,XM1A,
     XZTB,TARGB,'SOLI')
c    XZTB,TARGB,4HSOLI)
      CALL ELOSS(EIN,ZPIN,XM1A,ZT,TARGT,ABSORB)
3     ETARG = EIN
      CALL ENERGY (Q,EL,IENGY,QGS,2)
      ADAM=1.01
      DTHETA=DTHETA*DEGRAD/2.
      THDEG=ANGI
4     THETA(1)=THDEG*DEGRAD
C   
      WRITE(7,17)JRAK,QGS,EI,ETARG,XM1A,TARGT,XM2A,TBACK(1),TBACK(2),
     1XM3A,TBACKT,XM4A,NORDER,ZOUT
      WRITE(7,18)THDEG,DTHET
C   
      DO 5 J=1,2
      CALL RELKIN  (XM1A,XM2A,XM3A,XM4A,EIN,THETA,THCM3(J),CMTOLB(J),E3(
     1J),Q(J),IJ(J))
      IF (IJ(J).EQ.0) GO TO 11
      IF (TARGT.EQ.0.0) GO TO 5
      CALL ELOSS(E3(J),ZPOUT,XM3A,ZT,TARGT,ABSORB)
      IF (NORDER.EQ.2.AND.TBACKT.NE.0.0) CALL ELOSS (E3(J),ZPOUT,XM3A,
     XZTB,TARGB,'SOLI')
c    XZTB,TARGB,4HSOLI)
5      CONTINUE
      IF(TWO.EQ.1.0) WRITE(7,15)
      IF(SOLN2.EQ.1.0) WRITE(7,16)
      WRITE(7,24)
      DO 6 J=1,2
6     WRITE(7,25)Q(J),THCM3(J),CMTOLB(J),E3(J),EL(J)
      RHOD=ADAM*90.
      WRITE(7,26)
7     T=XM3A*XA
      TERMX=SE/ZOUT
      BD=TERMX*(DSQRT(E3(1)**2+2.*T*E3(1)))/RHOD
      FD=4.2578*BD
      DO 10 J=1,2
      RECOIL=XM1A+XM2A-XM3A-Q(J)/XA
      A(J)=TERMX*DSQRT(E3(J)**2+2.*T*E3(J))/BD
      IF (A(J)-30.) 8,9,9
 8    WRITE(7,22)THDEG,J
      GO TO 10
9     CALL OPTIC (A(J),E3(J),XM1A,XM3A,EIN,THETA,DTHETA,RECOIL,DTFP(J),D
     1EXIT(J),XI2PP(J),DK(J),ANOK(J))
10    CONTINUE
      CALL WHERE (Q,2,DEXIT,DTFP,XI2PP,TL,TR,RDIST,IJ,2)
      WRITE(7,23)A(1),ANOK(1),DK(1),RDIST(1),RDIST(2),TL,TR,BD,FD
      RHOD=RHOD-DELRHO
      IF (RHOD.GT.RHOMIN) GO TO 7
      THDEG=THDEG+DEL
      IF (THDEG-ANGFI) 4,4,1
C   
C   
   12 FORMAT(E8.0,2A4,3E8.0,A4)
13    FORMAT (8F10.6)
   14 FORMAT(4E8.0,A4,4X,2E8.0)
15    FORMAT (54H TWO SOLN TO RELKIN***PUNCH A 2 IN COL 73 OF JRAK CARD/
     1)
16    FORMAT (38H CALCULATION FOR SECOND SOLN TO RELKIN,//)
17    FORMAT (1H1,50X,31HOUTPUT FOR SUBROUTINE RHO      ,///,1H ,58X,8HR
     1EACTION,/,1H ,53X,6A4,/,51X,6H QGS =,F10.5,5H  MEV,///,41H KINEMAT
     2IC VARIABLES * * * * EBOMB(LAB) =,F10.5,5H  MEV,10X,34HENERGY LOSS
     3 INFO * * * * ETARGET =,F10.5,5H  MEV/,37X,5H M1 =,F10.5,5H  AMU,2
     46X,18HTARGET THICKNESS =,F10.5,8HMG/SQ-CM,/,37X,5H M2 =,F10.5,5H
     5AMU,28X,16HTARGET BACKING =,2A4,/,37X,5H M3 =,F10.5,5H  AMU,24X,20
     6H BACKING THICKNESS =,F10.5,8HMG/SQ-CM,/,37X,5H M4 =,F10.5,5H  AMU
     7,29X,15HBACKING ORDER =,I4,/,36X,6HZOUT =,F5.0,/)
18    FORMAT (//,42X,21H REACTION LAB ANGLE =,F10.5,5H  DEG,/,53X,10HAPE
     1RTURE =,F10.5,5H  DEG,//)
   20 FORMAT(10E8.0)
21    FORMAT (14H1FINDER FAILED,10X,6A4)
22    FORMAT (1H ,17H LESS THAN 30. CM,F9.5,2I5)
23    FORMAT (1H ,9F11.5)
24    FORMAT (36X,8H Q VALUE,2X,10H THETA3 CM,3X,7H CMTOLB,3X,7H E3 LAB,
     13X,7H ELEVEL,/)
25    FORMAT (36X,6F10.5)
26    FORMAT (//,6X,4H RHO,5X,9H .5DE/EDT,2X,10H KIN SHIFT,3X,7H RDIST1,
     13X,7H RDIST2,6X,3H TL,6X,3H TR,8X,6H FIELD,4X,5H FREQ,/)
   11 RETURN
      END
